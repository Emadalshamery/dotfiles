# Sources:
# * http://dougblack.io/words/zsh-vi-mode.html
# * http://superuser.com/a/648046
# * http://ivyl.0xcafe.eu/2013/02/03/refining-zsh/

# Engage Vi mode!
bindkey -v

# helper for setting color including all kinds of terminals
change_prompt_mode() {
  if [[ $TERM = "linux" ]]; then
    # nothing
  elif [[ $TMUX != '' ]]; then
    #echo -n '\033Ptmux;\033'
    #printf '\033]12;%b\007' "$1"
    #printf '\033]1337;CursorShape=%b\x7' "$2"
    #echo -n '\033\\'
  else
    #echo -ne "\033]12;$1\007"
    # iTerm specific: set cursor shape
    echo -ne "\033]1337;CursorShape=$2\x7"
  fi
}

reset_prompt() {
  # The zsh theme, which sets the prompt, actually checks to see which mode
  # we're in, so there's no need to do that here
  zle reset-prompt
}

zle-keymap-select() {
  reset_prompt
}

zle-line-init() {
  zle -K viins
  reset_prompt
}

zle-line-finish() {
  reset_prompt
}

zle -N zle-keymap-select
zle -N zle-line-init
zle -N zle-line-finish

# Use vim cli mode
bindkey '^P' up-history
bindkey '^N' down-history

# backspace and ^h working even after
# returning from command mode
bindkey '^?' backward-delete-char
bindkey '^h' backward-delete-char

# ctrl-w removed word backwards
bindkey '^w' backward-kill-word

# ctrl-r starts searching history backward
bindkey '^r' history-incremental-search-backward

# Reduce delay in switching between modes
export KEYTIMEOUT=1

# Tell zsh not to wait after pressing Escape
bindkey -sM vicmd '^[' '^G'
# Don't mess with existing widgets
bindkey -rM viins '^X'
bindkey -M viins '^X,' _history-complete-newer \
                 '^X/' _history-complete-older \
                 '^X`' _bash_complete-word

autoload -U select-word-style
select-word-style bash

# vi: ft=sh
